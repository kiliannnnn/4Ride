---
import Layout from "@/layouts/Main.astro";
import AskOllama from "@/components/AskOllama";
import { getLangFromUrl } from '@/i18n/utils';
import { listVehicles } from '@/lib/services/vehiclesServices';
const lang = getLangFromUrl(Astro.url);

type Vehicle = { brand: string; model: string | null; year: number | null; id: string };

let vehicles: Vehicle[] = [];
try {
  vehicles = await listVehicles();
} catch (e) {
  vehicles = [{ brand: 'Error', model: 'fetching', year: 0, id: '0' }];
}

let apiVehicles: Vehicle[] = [];
try {
  const apiUrl = new URL('/api/vehicles/list', Astro.url).toString();
  const res = await fetch(apiUrl);
  if (res.ok) {
    const json = await res.json();
    apiVehicles = json.vehicles || [];
  } else {
    apiVehicles = [{ brand: 'API error', model: '', year: 0, id: '0' }];
  }
} catch (e) {
  apiVehicles = [{ brand: 'API fetch error', model: '', year: 0, id: '0' }];
}
---

<Layout>
  <div>
    <h2>Debug: Create Vehicle (POST)</h2>
    <form id="debug-create-form">
      <label>Brand* <input name="brand" required /></label>
      <label>Model <input name="model" /></label>
      <label>Year <input name="year" type="number" /></label>
      <label>Engine Size <input name="engine_size" type="number" /></label>
      <label>Mileage <input name="mileage" type="number" /></label>
      <button type="submit">Create</button>
    </form>
    <div id="debug-create-result"></div>
    <script type="module">
      const form = document.getElementById('debug-create-form');
      const resultDiv = document.getElementById('debug-create-result');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultDiv.textContent = 'Submitting...';
        const data = Object.fromEntries(new FormData(form));
        // Convert number fields
        if (data.year) data.year = Number(data.year);
        if (data.engine_size) data.engine_size = Number(data.engine_size);
        if (data.mileage) data.mileage = Number(data.mileage);
        try {
          const res = await fetch('/api/vehicles/debug-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const json = await res.json();
          if (res.ok) {
            resultDiv.textContent = 'Created: ' + JSON.stringify(json.vehicle);
            form.reset();
            // Optionally, reload the page or fetch new lists
            setTimeout(() => window.location.reload(), 1000);
          } else {
            resultDiv.textContent = 'Error: ' + (json.error || 'Unknown error');
          }
        } catch (err) {
          resultDiv.textContent = 'Network error';
        }
      });
    </script>
  </div>
  <div>
    <h2>Debug: Vehicles (Direct Supabase)</h2>
    <ul>
      {vehicles.slice(0, 5).map((vehicle: Vehicle) => (
        <li><b>{vehicle.brand}</b> {vehicle.model} ({vehicle.year}) - id: {vehicle.id}</li>
      ))}
    </ul>
  </div>
  <div>
    <h2>Debug: Vehicles (API)</h2>
    <ul>
      {apiVehicles.slice(0, 5).map((vehicle: Vehicle) => (
        <li><b>{vehicle.brand}</b> {vehicle.model} ({vehicle.year}) - id: {vehicle.id}</li>
      ))}
    </ul>
  </div>
  <AskOllama client:load lang={lang} />
</Layout>
